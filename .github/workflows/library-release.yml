name: Library Release

on:
  push:
    tags:
    - "v*"

permissions:
  contents: write

jobs:
  build-libraries:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.22'

    - name: Get dependencies
      run: go mod download

    - name: Build Linux AMD64 static binary
      run: |
        env CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -ldflags "-s -w -X main.Version=`git rev-parse HEAD`" -o geesefs .

    - name: Generate checksums
      run: |
        sha256sum geesefs > checksums.txt

    - name: Upload library artifacts to release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          geesefs
          checksums.txt
        body: |
          ## Static Binary

          This release includes a statically linked binary:

          ### Static Binary - Linux AMD64
          - `geesefs` - Standalone executable with all dependencies statically linked

          ### Verification
          - `checksums.txt` - SHA256 checksum for the binary

          ### Usage
          **Direct execution:** Download `geesefs`, make it executable (`chmod +x geesefs`), and run it directly.
          
          **For Go projects:** Use `go get github.com/yandex-cloud/geesefs`

          The binary is completely self-contained with no external dependencies required.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 