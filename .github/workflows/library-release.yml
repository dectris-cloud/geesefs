name: Library Release

on:
  push:
    tags:
    - "v*"

permissions:
  contents: write

jobs:
  build-libraries:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.22'

    - name: Get dependencies
      run: go mod download

    - name: Build Linux AMD64 static library
      run: |
        mkdir -p build/linux-amd64
        env CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -buildmode=c-archive -o build/linux-amd64/libgeesefs.a -ldflags "-X main.Version=`git rev-parse HEAD`" .
        tar -czf geesefs-linux-amd64-static.tar.gz -C build/linux-amd64 .

    - name: Create Go module archive
      run: |
        mkdir -p build/go-module
        cp -r . build/go-module/
        cd build/go-module
        # Clean up unnecessary files
        rm -rf .git .github build
        tar -czf ../../geesefs-go-module.tar.gz .

    - name: Generate checksums
      run: |
        sha256sum *.tar.gz > checksums.txt

    - name: Upload library artifacts to release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          geesefs-linux-amd64-static.tar.gz
          geesefs-go-module.tar.gz
          checksums.txt
        body: |
          ## Library Artifacts

          This release includes the following library formats:

          ### Static Library (C-Archive) - Linux AMD64 Only
          - `geesefs-linux-amd64-static.tar.gz` - Linux AMD64 static library (.a + .h)

          ### Go Module
          - `geesefs-go-module.tar.gz` - Complete Go module source code

          ### Verification
          - `checksums.txt` - SHA256 checksums for all library artifacts

          Each archive contains the compiled static library file and corresponding C header file for integration with C/C++ projects.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 