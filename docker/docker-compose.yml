services:
  # MinIO S3-compatible storage
  minio:
    image: minio/minio:latest
    container_name: geesefs-minio
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"   # S3 API
      - "9001:9001"   # MinIO Console
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - geesefs-network

  # MinIO client to create bucket on startup
  minio-init:
    image: minio/mc:latest
    container_name: geesefs-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 minioadmin minioadmin;
      mc mb myminio/testbucket --ignore-existing;
      mc anonymous set public myminio/testbucket;
      echo 'Bucket testbucket created and configured';
      exit 0;
      "
    networks:
      - geesefs-network

  # GeeseFS container 1 - mounts the S3 bucket
  geesefs-1:
    build:
      context: ..
      dockerfile: docker/Dockerfile.geesefs
    container_name: geesefs-mount-1
    depends_on:
      minio-init:
        condition: service_completed_successfully
    privileged: true
    cap_add:
      - SYS_ADMIN
    devices:
      - /dev/fuse
    security_opt:
      - apparmor:unconfined
    environment:
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      S3_ENDPOINT: http://minio:9000
      S3_BUCKET: testbucket
      MOUNT_POINT: /mnt/s3
      GEESEFS_OPTS: "--debug_s3 --debug_fuse --enable-symlinks-file --stat-cache-ttl 1s"
    networks:
      - geesefs-network
    healthcheck:
      test: ["CMD", "mountpoint", "-q", "/mnt/s3"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # GeeseFS container 2 - mounts the same S3 bucket
  geesefs-2:
    build:
      context: ..
      dockerfile: docker/Dockerfile.geesefs
    container_name: geesefs-mount-2
    depends_on:
      minio-init:
        condition: service_completed_successfully
    privileged: true
    cap_add:
      - SYS_ADMIN
    devices:
      - /dev/fuse
    security_opt:
      - apparmor:unconfined
    environment:
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      S3_ENDPOINT: http://minio:9000
      S3_BUCKET: testbucket
      MOUNT_POINT: /mnt/s3
      GEESEFS_OPTS: "--debug_s3 --debug_fuse --enable-symlinks-file --stat-cache-ttl 1s"
    networks:
      - geesefs-network
    healthcheck:
      test: ["CMD", "mountpoint", "-q", "/mnt/s3"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Test container for conditional write tests using S3 API directly
  conditional-write-test:
    build:
      context: .
      dockerfile: Dockerfile.test-conditional
    container_name: geesefs-conditional-test
    depends_on:
      geesefs-1:
        condition: service_healthy
      geesefs-2:
        condition: service_healthy
    environment:
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      S3_ENDPOINT: http://minio:9000
      S3_BUCKET: testbucket
    networks:
      - geesefs-network
    command: ["python3", "/app/test_conditional_writes.py"]

  # Test container that uses MinIO client to verify files
  test-client:
    image: minio/mc:latest
    container_name: geesefs-test-client
    depends_on:
      geesefs-1:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 minioadmin minioadmin;
      echo 'Listing bucket contents:';
      mc ls myminio/testbucket;
      echo 'Test completed!';
      sleep infinity
      "
    networks:
      - geesefs-network

  # Test container for symlinks file tests
  symlinks-test:
    image: docker:cli
    container_name: geesefs-symlinks-test
    depends_on:
      geesefs-1:
        condition: service_healthy
      geesefs-2:
        condition: service_healthy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./test_symlinks_file.sh:/test_symlinks_file.sh:ro
    working_dir: /
    command: ["sh", "/test_symlinks_file.sh"]
    networks:
      - geesefs-network

volumes:
  minio-data:

networks:
  geesefs-network:
    driver: bridge
