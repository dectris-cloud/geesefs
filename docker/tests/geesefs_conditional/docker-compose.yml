# GeeseFS Conditional Writes Test - Tests conditional writes through FUSE mount
# Usage: docker compose up --build

services:
  # MinIO S3-compatible storage
  minio:
    image: minio/minio:latest
    container_name: geesefs-conditional-minio
    command: server /data --console-address ":9001"
    ports:
      - "9200:9000"
      - "9201:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - test-network

  # MinIO client to create bucket on startup
  minio-init:
    image: minio/mc:latest
    container_name: geesefs-conditional-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 minioadmin minioadmin;
      mc mb myminio/testbucket --ignore-existing;
      mc anonymous set public myminio/testbucket;
      echo 'Bucket testbucket created and configured';
      exit 0;
      "
    networks:
      - test-network

  # GeeseFS container 1
  geesefs-1:
    build:
      context: ../../..
      dockerfile: docker/tests/geesefs_conditional/Dockerfile.geesefs
    container_name: geesefs-conditional-mount-1
    depends_on:
      minio-init:
        condition: service_completed_successfully
    privileged: true
    cap_add:
      - SYS_ADMIN
    devices:
      - /dev/fuse
    security_opt:
      - apparmor:unconfined
    environment:
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      S3_ENDPOINT: http://minio:9000
      S3_BUCKET: testbucket
      MOUNT_POINT: /mnt/s3
      GEESEFS_OPTS: "--debug_s3 --debug_fuse --stat-cache-ttl 30s"
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "mountpoint", "-q", "/mnt/s3"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # GeeseFS container 2
  geesefs-2:
    build:
      context: ../../..
      dockerfile: docker/tests/geesefs_conditional/Dockerfile.geesefs
    container_name: geesefs-conditional-mount-2
    depends_on:
      minio-init:
        condition: service_completed_successfully
    privileged: true
    cap_add:
      - SYS_ADMIN
    devices:
      - /dev/fuse
    security_opt:
      - apparmor:unconfined
    environment:
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      S3_ENDPOINT: http://minio:9000
      S3_BUCKET: testbucket
      MOUNT_POINT: /mnt/s3
      GEESEFS_OPTS: "--debug_s3 --debug_fuse --stat-cache-ttl 30s"
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "mountpoint", "-q", "/mnt/s3"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Test runner container
  test:
    image: docker:cli
    container_name: geesefs-conditional-test
    depends_on:
      geesefs-1:
        condition: service_healthy
      geesefs-2:
        condition: service_healthy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./test_geesefs_conditional.sh:/test.sh:ro
    working_dir: /
    command: ["sh", "/test.sh"]
    networks:
      - test-network

volumes:
  minio-data:

networks:
  test-network:
    driver: bridge
